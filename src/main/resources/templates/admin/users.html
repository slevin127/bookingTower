<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: layout(~{::title}, ~{::sidebar}, ~{::content})}">
<head>
    <title>Управление пользователями - BookingTower</title>
</head>
<body>
    <!-- Sidebar Menu -->
    <ul class="nav flex-column" th:fragment="sidebar">
        <li class="nav-item">
            <a class="nav-link" th:href="@{/admin/dashboard}">
                <i class="fas fa-tachometer-alt me-2"></i>
                Панель управления
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" th:href="@{/admin/bookings}">
                <i class="fas fa-calendar-check me-2"></i>
                Бронирования
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link active" th:href="@{/admin/users}">
                <i class="fas fa-users me-2"></i>
                Пользователи
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" th:href="@{/admin/workspaces}">
                <i class="fas fa-building me-2"></i>
                Рабочие места
            </a>
        </li>
    </ul>

    <!-- Main Content -->
    <div th:fragment="content">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-users me-2"></i>Управление пользователями</h1>
                <div>
                    <a th:href="@{/register}" class="btn btn-primary">
                        <i class="fas fa-user-plus me-2"></i>Добавить пользователя
                    </a>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <form method="get" class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Тип пользователя</label>
                                    <select name="userType" class="form-select">
                                        <option value="">Все типы</option>
                                        <option value="INDIVIDUAL" th:selected="${param.userType != null and param.userType[0] == 'INDIVIDUAL'}">Физические лица</option>
                                        <option value="LEGAL_ENTITY" th:selected="${param.userType != null and param.userType[0] == 'LEGAL_ENTITY'}">Юридические лица</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Роль</label>
                                    <select name="role" class="form-select">
                                        <option value="">Все роли</option>
                                        <option value="USER" th:selected="${param.role != null and param.role[0] == 'USER'}">Пользователи</option>
                                        <option value="ADMIN" th:selected="${param.role != null and param.role[0] == 'ADMIN'}">Администраторы</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Статус email</label>
                                    <select name="emailVerified" class="form-select">
                                        <option value="">Все</option>
                                        <option value="true" th:selected="${param.emailVerified != null and param.emailVerified[0] == 'true'}">Подтвержден</option>
                                        <option value="false" th:selected="${param.emailVerified != null and param.emailVerified[0] == 'false'}">Не подтвержден</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-outline-primary">
                                            <i class="fas fa-search me-2"></i>Фильтр
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Users Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i>Список пользователей
                                <span class="badge bg-secondary ms-2" th:text="${users.totalElements}">0</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>ID</th>
                                            <th>Тип</th>
                                            <th>Email</th>
                                            <th>Имя/Название</th>
                                            <th>Роль</th>
                                            <th>Email подтвержден</th>
                                            <th>Дата регистрации</th>
                                            <th>Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="user : ${users.content}">
                                            <td th:text="${user.id}">1</td>
                                            <td>
                                                <span class="badge" 
                                                      th:classappend="${user.userType == T(org.example.bookingtower.domain.entity.User.UserType).INDIVIDUAL} ? 'bg-info' : 'bg-warning'"
                                                      th:text="${user.userType == T(org.example.bookingtower.domain.entity.User.UserType).INDIVIDUAL} ? 'Физ. лицо' : 'Юр. лицо'">
                                                    Физ. лицо
                                                </span>
                                            </td>
                                            <td th:text="${user.email}">user@example.com</td>
                                            <td>
                                                <div th:if="${user.userType == T(org.example.bookingtower.domain.entity.User.UserType).INDIVIDUAL}">
                                                    <strong th:text="${user.fullName}">Иван Иванов</strong>
                                                    <br>
                                                    <small class="text-muted" th:text="${user.phone}" th:if="${user.phone}">+7 (999) 999-99-99</small>
                                                </div>
                                                <div th:if="${user.userType == T(org.example.bookingtower.domain.entity.User.UserType).LEGAL_ENTITY}">
                                                    <strong th:text="${user.companyName}">ООО "Компания"</strong>
                                                    <br>
                                                    <small class="text-muted">
                                                        ИНН: <span th:text="${user.inn}">1234567890</span>
                                                        <span th:if="${user.kpp}">
                                                            | КПП: <span th:text="${user.kpp}">123456789</span>
                                                        </span>
                                                    </small>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge" 
                                                      th:classappend="${user.role == T(org.example.bookingtower.domain.entity.User.Role).ADMIN} ? 'bg-danger' : 'bg-primary'"
                                                      th:text="${user.role}">
                                                    USER
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge" 
                                                      th:classappend="${user.emailVerified} ? 'bg-success' : 'bg-warning'"
                                                      th:text="${user.emailVerified} ? 'Да' : 'Нет'">
                                                    Да
                                                </span>
                                            </td>
                                            <td th:text="${#temporals.format(user.createdAt, 'dd.MM.yyyy HH:mm')}">01.01.2024 10:00</td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <button type="button" class="btn btn-sm btn-outline-info" 
                                                            data-bs-toggle="modal" 
                                                            th:data-bs-target="'#userModal' + ${user.id}"
                                                            title="Просмотр деталей">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-warning"
                                                            th:if="${!user.emailVerified}"
                                                            onclick="resendVerification(this)"
                                                            th:data-email="${user.email}"
                                                            title="Повторно отправить подтверждение">
                                                        <i class="fas fa-envelope"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-success"
                                                            th:if="${user.role == T(org.example.bookingtower.domain.entity.User.Role).USER}"
                                                            onclick="promoteToAdmin(this)"
                                                            th:data-user-id="${user.id}"
                                                            title="Сделать администратором">
                                                        <i class="fas fa-user-shield"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-danger"
                                                            th:if="${user.role != T(org.example.bookingtower.domain.entity.User.Role).ADMIN or totalAdmins > 1}"
                                                            onclick="deleteUser(this)"
                                                            th:data-user-id="${user.id}"
                                                            th:data-user-email="${user.email}"
                                                            title="Удалить пользователя">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pagination -->
                            <nav th:if="${users.totalPages > 1}" class="mt-4">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item" th:classappend="${users.first} ? 'disabled'">
                                        <a class="page-link" th:href="@{/admin/users(page=${users.number - 1}, size=${users.size})}">
                                            <i class="fas fa-chevron-left"></i>
                                        </a>
                                    </li>
                                    
                                    <li class="page-item" 
                                        th:each="i : ${#numbers.sequence(0, users.totalPages - 1)}" 
                                        th:classappend="${i == users.number} ? 'active'">
                                        <a class="page-link" 
                                           th:href="@{/admin/users(page=${i}, size=${users.size})}" 
                                           th:text="${i + 1}">1</a>
                                    </li>
                                    
                                    <li class="page-item" th:classappend="${users.last} ? 'disabled'">
                                        <a class="page-link" th:href="@{/admin/users(page=${users.number + 1}, size=${users.size})}">
                                            <i class="fas fa-chevron-right"></i>
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- User Detail Modals -->
        <div th:each="user : ${users.content}" 
             class="modal fade" 
             th:id="'userModal' + ${user.id}" 
             tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-user me-2"></i>
                            Детали пользователя
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Основная информация</h6>
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>ID:</strong></td>
                                        <td th:text="${user.id}">1</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Email:</strong></td>
                                        <td th:text="${user.email}">user@example.com</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Тип:</strong></td>
                                        <td th:text="${user.userType == T(org.example.bookingtower.domain.entity.User.UserType).INDIVIDUAL} ? 'Физическое лицо' : 'Юридическое лицо'">Физическое лицо</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Роль:</strong></td>
                                        <td th:text="${user.role}">USER</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Email подтвержден:</strong></td>
                                        <td th:text="${user.emailVerified} ? 'Да' : 'Нет'">Да</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Дата регистрации:</strong></td>
                                        <td th:text="${#temporals.format(user.createdAt, 'dd.MM.yyyy HH:mm')}">01.01.2024 10:00</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <div th:if="${user.userType == T(org.example.bookingtower.domain.entity.User.UserType).INDIVIDUAL}">
                                    <h6>Личные данные</h6>
                                    <table class="table table-sm">
                                        <tr th:if="${user.lastName}">
                                            <td><strong>Фамилия:</strong></td>
                                            <td th:text="${user.lastName}">Иванов</td>
                                        </tr>
                                        <tr th:if="${user.firstName}">
                                            <td><strong>Имя:</strong></td>
                                            <td th:text="${user.firstName}">Иван</td>
                                        </tr>
                                        <tr th:if="${user.middleName}">
                                            <td><strong>Отчество:</strong></td>
                                            <td th:text="${user.middleName}">Иванович</td>
                                        </tr>
                                        <tr th:if="${user.phone}">
                                            <td><strong>Телефон:</strong></td>
                                            <td th:text="${user.phone}">+7 (999) 999-99-99</td>
                                        </tr>
                                    </table>
                                </div>
                                <div th:if="${user.userType == T(org.example.bookingtower.domain.entity.User.UserType).LEGAL_ENTITY}">
                                    <h6>Данные организации</h6>
                                    <table class="table table-sm">
                                        <tr th:if="${user.companyName}">
                                            <td><strong>Название:</strong></td>
                                            <td th:text="${user.companyName}">ООО "Компания"</td>
                                        </tr>
                                        <tr th:if="${user.inn}">
                                            <td><strong>ИНН:</strong></td>
                                            <td th:text="${user.inn}">1234567890</td>
                                        </tr>
                                        <tr th:if="${user.ogrn}">
                                            <td><strong>ОГРН:</strong></td>
                                            <td th:text="${user.ogrn}">1234567890123</td>
                                        </tr>
                                        <tr th:if="${user.kpp}">
                                            <td><strong>КПП:</strong></td>
                                            <td th:text="${user.kpp}">123456789</td>
                                        </tr>
                                        <tr th:if="${user.legalAddress}">
                                            <td><strong>Юр. адрес:</strong></td>
                                            <td th:text="${user.legalAddress}">Адрес</td>
                                        </tr>
                                        <tr th:if="${user.actualAddress}">
                                            <td><strong>Факт. адрес:</strong></td>
                                            <td th:text="${user.actualAddress}">Адрес</td>
                                        </tr>
                                        <tr th:if="${user.directorName}">
                                            <td><strong>Руководитель:</strong></td>
                                            <td th:text="${user.directorName}">ФИО</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block th:fragment="scripts">
        <script>
            function resendVerification(button) {
                const email = button.getAttribute('data-email');
                if (confirm(`Повторно отправить подтверждение на ${email}?`)) {
                    fetch('/resend-verification', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `email=${encodeURIComponent(email)}`
                    })
                    .then(response => {
                        if (response.ok) {
                            alert('Письмо с подтверждением отправлено');
                        } else {
                            alert('Ошибка при отправке письма');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Ошибка при отправке письма');
                    });
                }
            }

            function promoteToAdmin(button) {
                const userId = button.getAttribute('data-user-id');
                if (confirm('Сделать пользователя администратором?')) {
                    // This would need to be implemented in the backend
                    alert('Функция будет реализована в следующих версиях');
                }
            }

            function deleteUser(button) {
                const userId = button.getAttribute('data-user-id');
                const userEmail = button.getAttribute('data-user-email');
                if (confirm(`Удалить пользователя ${userEmail}? Это действие нельзя отменить.`)) {
                    // This would need to be implemented in the backend
                    alert('Функция будет реализована в следующих версиях');
                }
            }
        </script>
    </th:block>
</body>
</html>